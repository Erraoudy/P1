FROM ubuntu:bionic

MAINTAINER Marco Egger <m.egger@coozzy.com>

# Install PHP-FPM
RUN apt-get update \
  && apt-get upgrade -y \
  && apt-get install -y software-properties-common \
  && LC_ALL=C.UTF-8 add-apt-repository ppa:ondrej/php \
  && apt-get update \
  && apt-get install -y php7.2 php7.2-cli php7.2-common php7.2-curl php7.2-json php7.2-opcache php7.2-mysql php7.2-mbstring php7.2-bcmath php7.2-zip php7.2-xml php7.2-gd php7.2-redis php7.2-fpm \
  && apt-get install -y nano curl \
  && service php7.2-fpm start

# Install Node.js and JS uglify module
RUN curl -sL https://deb.nodesource.com/setup_8.x | bash - \
  && apt-get install -y nodejs \
  && npm install -g uglify-es uglifycss 

# Install Ruby for assetic building
RUN apt-get install -y ruby-full gcc ruby-compass \
  && gem update --system

# Install GZIP and Brotli to compress static files
RUN apt-get install -y gzip brotli

# Build and install nginx with Brotli and PageSpeed module
RUN apt-get update \
  && apt-get install -y build-essential zlib1g-dev libpcre3-dev libssl-dev libxslt1-dev libxml2-dev libgd-dev libgeoip-dev libgoogle-perftools-dev libperl-dev openssl wget git \
  && cd /usr/local/src \
  && wget https://nginx.org/download/nginx-1.15.5.tar.gz \
  && tar -xzf nginx-1.15.5.tar.gz \
  && rm nginx-1.15.5.tar.gz \
  && git clone https://github.com/google/ngx_brotli.git \
  && cd ngx_brotli \
  && git submodule update --init --recursive \
  && cd /usr/local/src/nginx-1.15.5\
  && chown -R root: /usr/local/src \
  && chmod -R 775 /usr/local/src \
  && mkdir -p /var/lib/nginx/body \
  && ./configure --with-cc-opt='-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2' --with-ld-opt='-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now' --prefix=/usr/share/nginx --conf-path=/etc/nginx/nginx.conf --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --lock-path=/var/lock/nginx.lock --pid-path=/run/nginx.pid --http-client-body-temp-path=/var/lib/nginx/body --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --http-proxy-temp-path=/var/lib/nginx/proxy --http-scgi-temp-path=/var/lib/nginx/scgi --http-uwsgi-temp-path=/var/lib/nginx/uwsgi --with-debug --with-pcre-jit --with-ipv6 --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_addition_module --with-http_dav_module --with-http_geoip_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module --with-http_v2_module --with-http_sub_module --with-http_xslt_module --with-stream --with-stream_ssl_module --with-mail --with-mail_ssl_module --with-threads --add-module=/usr/local/src/ngx_brotli --sbin-path=/usr/sbin/nginx \
  && make \
  && make install

# Install wkhtmltopdf
RUN apt-get update \
  && apt-get install -y xvfb libfontconfig wkhtmltopdf

# Cleanup
RUN rm -rf /usr/local/src \
  && apt-get purge -y wget git \
  && apt-get clean \
  && apt-get autoremove -y \
  && rm -rf /var/lib/apt/lists/*


# Copy php configs
COPY ./docker/app/php/php.ini /etc/php/7.2/fpm/php.ini
COPY ./docker/app/php/opcache.ini /etc/php/7.2/fpm/conf.d/10-opcache.ini
COPY ./docker/app/php/www.conf /etc/php/7.2/fpm/pool.d/www.conf

# Copy nginx configs
COPY ./docker/app/nginx/nginx.conf /etc/nginx/nginx.conf
COPY ./docker/app/nginx/snippets/fastcgi-php.conf /etc/nginx/snippets/fastcgi-php.conf
COPY ./docker/app/nginx/sites/symfony-local.conf /etc/nginx/sites/default.conf

WORKDIR /var/www

CMD php-fpm7.2 && nginx -g 'daemon off;'
